<!DOCTYPE html>
<html>
<head>
    <title>Audio Processor</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #1a1a1a; 
            color: #e0e0e0; 
            text-align: center; 
            touch-action: none;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 90vh;
            overflow: hidden;
        }
        h2 {
            font-weight: 300;
            font-size: 1.5em;
            margin: 10px 0;
        }
        #annoyanceLevelDisplay {
            font-weight: 600;
            color: #FFC107;
        }
        #shushMessage {
            display: none; 
            font-size: 4em; 
            font-weight: bold;
            color: #F44336; 
            margin-top: 20px;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        #mainContent { 
            display: none; 
            width: 100%;
        }
        #startButton {
            padding: 15px 30px;
            font-size: 1.2em;
            cursor: pointer;
            border-radius: 8px;
            border: none;
            background-color: #4CAF50;
            color: white;
        }
        /* Styles for the new sound visualizer */
        #visualizerContainer {
            width: 80px;
            height: 200px;
            background-color: #333;
            border: 2px solid #555;
            border-radius: 8px;
            margin: 20px auto;
            position: relative;
            overflow: hidden;
        }
        #soundBar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0%; /* Starts at 0, height is controlled by JS */
            background: linear-gradient(to top, #4CAF50, #F44336);
            transition: height 0.05s linear;
        }
        #thresholdLine {
            position: absolute;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: #2196F3;
            bottom: 50%; /* Default position, controlled by JS */
            transition: bottom 0.2s ease;
        }
    </style>
</head>
<body>
    <div id="startScreen">
        <button id="startButton">Start Monitoring</button>
    </div>

    <div id="mainContent">
        <div id="visualizerContainer">
            <div id="soundBar"></div>
            <div id="thresholdLine"></div>
        </div>
        <h2>Annoyance Level: <span id="annoyanceLevelDisplay">0</span></h2>
        <div id="shushMessage">Shusssshhhhh</div>
    </div>
    
    <script>
        // --- CONFIGURATION & STATE VARIABLES ---
        let volumeThreshold = 50; // The noise level that is considered a "breach" (0-100)
        let breachRecords = [];   // Stores recent sound breaches { timestamp, magnitude }
        let isShushing = false;   // Flag to prevent the "shush" message from re-triggering while visible
        
        // This constant helps normalize the annoyance score to a 0-100 scale.
        // It's an estimated max score based on frequent, loud breaches. May need tuning.
        const MAX_ANNOYANCE_SCORE = 3000; 

        // --- COMMUNICATION WITH THUNKABLE ---
        // Listens for messages from the Thunkable app to change the threshold
        window.addEventListener('message', function(event) {
            const message = event.data;
            if (typeof message === 'string' && message.startsWith('SET_THRESHOLD:')) {
                const newThreshold = Number(message.split(':')[1]);
                if (!isNaN(newThreshold)) {
                    volumeThreshold = newThreshold;
                    // Update the visual position of the threshold line
                    document.getElementById('thresholdLine').style.bottom = `${volumeThreshold}%`;
                }
            }
        });

        // --- CORE AUDIO PROCESSING LOGIC ---
        async function startMonitoring() {
            // Hide the start button and show the main monitoring UI
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';

            try {
                // Request access to the user's microphone
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                
                // Set up the Web Audio API components for analysis
                const audioContext = new AudioContext();
                const mediaStreamSource = audioContext.createMediaStreamSource(stream);
                const analyser = audioContext.createAnalyser();
                analyser.fftSize = 256; // Determines the detail of the sound analysis
                mediaStreamSource.connect(analyser);

                const dataArray = new Uint8Array(analyser.frequencyBinCount);

                // --- MAIN LOOP ---
                // This function runs continuously to check the sound level
                function checkSoundLevel() {
                    // Get the current sound frequency data from the analyser
                    analyser.getByteFrequencyData(dataArray);
                    
                    // Calculate the average volume from the frequency data
                    let sum = 0;
                    for (const amplitude of dataArray) { sum += amplitude * amplitude; }
                    const rawVolume = Math.sqrt(sum / dataArray.length);
                    
                    // Convert raw volume to a more natural-feeling logarithmic scale (0-100)
                    const scaledVolume = Math.min(100, Math.round(18 * Math.log(rawVolume + 1)));
                    
                    // Update the height of the visual sound bar
                    document.getElementById('soundBar').style.height = `${scaledVolume}%`;
                    
                    // Check if the current volume exceeds the set threshold
                    if (scaledVolume > volumeThreshold) {
                        // If it does, record the breach with its timestamp and how loud it was
                        breachRecords.push({
                            timestamp: Date.now(),
                            magnitude: scaledVolume - volumeThreshold // How much it went over
                        });
                    }

                    // Calculate the "Annoyance Level" based on recent breaches
                    const annoyanceLevel = calculateAnnoyanceLevel();
                    document.getElementById('annoyanceLevelDisplay').textContent = annoyanceLevel;

                    // Trigger the "shush" message if annoyance is high and it's not already showing
                    if (annoyanceLevel > 50 && !isShushing) {
                        isShushing = true; // Set flag to prevent re-triggering
                        const shushElement = document.getElementById('shushMessage');
                        shushElement.style.display = 'block';
                        
                        // After 10 seconds, hide the message and allow it to be triggered again
                        setTimeout(() => {
                            shushElement.style.display = 'none';
                            isShushing = false;
                        }, 10000);
                    }
                    
                    // Request the next animation frame to continue the loop smoothly
                    requestAnimationFrame(checkSoundLevel);
                }
                checkSoundLevel(); // Start the loop
            
            } catch (err) {
                // Handle errors, like the user denying microphone permission
                document.getElementById('mainContent').innerHTML = `<p style="color:red;">Error: ${err.message}. Please allow microphone access.</p>`;
                console.error('Error:', err);
            }
        }

        // --- ANNOYANCE CALCULATION FUNCTION ---
        function calculateAnnoyanceLevel() {
            const now = Date.now();
            const tenSecondsAgo = now - 10000;

            // 1. Filter out any breach records that are older than 10 seconds
            breachRecords = breachRecords.filter(record => record.timestamp > tenSecondsAgo);

            if (breachRecords.length === 0) {
                return 0; // If no recent breaches, annoyance is 0
            }

            // 2. Calculate a total "annoyance score"
            let totalScore = 0;
            for (const record of breachRecords) {
                // a. Calculate a recency weight (0.0 to 1.0)
                // Breaches that just happened have a weight near 1.0.
                // Breaches from almost 10 seconds ago have a weight near 0.0.
                const recencyWeight = (record.timestamp - tenSecondsAgo) / 10000;
                
                // b. The score for this breach is its magnitude multiplied by its recency
                totalScore += record.magnitude * recencyWeight;
            }

            // 3. Normalize the raw score to a 0-100 scale and return it
            const normalizedLevel = Math.min(100, Math.round((totalScore / MAX_ANNOYANCE_SCORE) * 100));
            return normalizedLevel;
        }

        // --- EVENT LISTENER ---
        // Attaches the startMonitoring function to the "Start" button's click event
        document.getElementById('startButton').addEventListener('click', startMonitoring);
    </script>
</body>
</html>
