<!DOCTYPE html>
<html>
<head>
    <title>Audio Processor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            box-sizing: border-box;
        }
        html, body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #212121;
            color: #e0e0e0; 
            text-align: center; 
            touch-action: none;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            width: 100%;
            min-height: 100%;
            overflow-y: auto;
            margin: 0;
            padding: 20px 10px;
        }
        #mainContainer { display: flex; flex-direction: column; align-items: center; width: 100%;}
        #startButton {
            padding: 15px 30px;
            font-size: 1.2em;
            cursor: pointer;
            border-radius: 8px;
            border: none;
            background-color: #00796B;
            color: white;
            margin-bottom: 20px;
        }
        #displayArea {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 10px auto;
        }
        #statusTextContainer {
            text-align: left;
            min-width: 160px;
        }
        #visualizerContainer {
            width: 80px;
            height: 150px;
            background-color: #333;
            border: 2px solid #555;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }
        #soundBar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0%;
            background: linear-gradient(to top, #4A90E2, #F5A623);
            transition: height 0.1s linear;
        }
        #triggerLine {
            position: absolute;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: #00796B; /* Default to green */
            bottom: 50%;
            transition: all 0.2s ease;
        }
        .controls { margin-top: 15px; width: 90%; max-width: 300px; }
        .control-group { margin-bottom: 10px; text-align: left; position: relative; }
        .control-group label { display: block; margin-bottom: 5px; font-size: 0.9em; }
        .control-group .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .control-group input[type="range"] { 
            flex-grow: 1;
            width: 100%; 
            -webkit-appearance: none;
            background: transparent;
        }
        .control-group input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #00796B;
            cursor: pointer;
            margin-top: -6px;
        }
        .control-group input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #555;
            border-radius: 2px;
        }
        .control-group input[type=range]::-moz-range-thumb {
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #00796B;
            cursor: pointer;
        }
        .control-group input[type=range]::-moz-range-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #555;
            border-radius: 2px;
        }
        .status-display { margin-bottom: 5px; }
        
        #screensaver {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #000;
            z-index: 100;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        #screensaverText {
            color: #888;
            margin-bottom: 20px;
            font-size: 1.2em;
        }
        #returnButton {
            padding: 15px 30px;
            font-size: 1.2em;
            cursor: pointer;
            border-radius: 8px;
            border: 1px solid #555;
            background-color: #333;
            color: #ccc;
        }

        .advanced-controls summary {
            cursor: pointer;
            padding: 8px;
            background-color: #333;
            border-radius: 4px;
            margin: 15px 0 10px 0;
            outline: none;
        }
        .advanced-controls[open] summary {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }
        .advanced-controls .details-content {
            padding: 10px;
            background-color: #2a2a2a;
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
        }
        .switch-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .info-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: #888;
            color: #212121;
            text-align: center;
            font-weight: bold;
            font-size: 12px;
            line-height: 16px;
            cursor: pointer;
            user-select: none;
            flex-shrink: 0;
        }
        .tooltip {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 10;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        .tooltip.show {
            visibility: visible;
            opacity: 1;
        }
        h2 {
            position: relative;
            display: inline-block;
        }

    </style>
</head>
<body>
    <div id="mainContainer">
        <button id="startButton">Start Monitoring (v4.1)</button>
        <div id="mainContent" style="width: 100%;">
            <h2>
                Noise Disturbance 
                <span class="info-icon" data-tooltip-id="tooltip-disturbance">?</span>
            </h2>
            <div class="tooltip" id="tooltip-disturbance">Disturbance is a combination of the volume and duration of recent sounds that exceed the sensitivity threshold.</div>

            <div id="displayArea">
                <div id="visualizerContainer">
                    <div id="soundBar"></div>
                    <div id="triggerLine"></div>
                </div>
                <div id="statusTextContainer">
                    <div class="status-display">Detected Sound: <span id="soundLevelValue">0</span></div>
                    <div class="status-display" id="activationStatus">-</div>
                </div>
            </div>
            <div class="controls">
                <div class="control-group">
                    <label for="triggerSlider">Disturbance Trigger: <span id="triggerValue">50</span></label>
                    <div class="slider-container">
                        <input type="range" id="triggerSlider" min="10" max="95" value="50">
                        <span class="info-icon" data-tooltip-id="tooltip-trigger">?</span>
                    </div>
                    <div class="tooltip" id="tooltip-trigger">Sets the disturbance level (red line) required to activate sound. A lower value is more sensitive.</div>
                </div>
                <div class="control-group">
                    <label for="sensitivitySlider">Sensitivity: <span id="sensitivityValue">50</span></label>
                    <div class="slider-container">
                        <input type="range" id="sensitivitySlider" min="1" max="100" value="50">
                        <span class="info-icon" data-tooltip-id="tooltip-sensitivity">?</span>
                    </div>
                    <div class="tooltip" id="tooltip-sensitivity">Adjusts microphone sensitivity. Higher values make it easier for quieter sounds to register as a disturbance.</div>
                </div>
                <div class="control-group">
                    <label for="volumeSlider">Volume: <span id="volumeValue">50%</span></label>
                    <div class="slider-container">
                        <input type="range" id="volumeSlider" min="0" max="100" value="50">
                        <span class="info-icon" data-tooltip-id="tooltip-volume">?</span>
                    </div>
                    <div class="tooltip" id="tooltip-volume">The maximum volume the white noise will reach after being activated.</div>
                </div>
                 <div class="control-group">
                    <label for="durationSlider">Playing Time: <span id="durationValue">30s</span></label>
                    <div class="slider-container">
                        <input type="range" id="durationSlider" min="1" max="100" value="25">
                        <span class="info-icon" data-tooltip-id="tooltip-duration">?</span>
                    </div>
                    <div class="tooltip" id="tooltip-duration">How long the white noise will gently fade out for after it has been activated and the disturbance ends.</div>
                </div>
                
                <div class="control-group switch-group">
                    <label for="screensaverToggle">Enable Screensaver</label>
                    <input type="checkbox" id="screensaverToggle" checked>
                </div>

                <details class="advanced-controls">
                    <summary>Advanced Settings</summary>
                    <div class="details-content">
                        <div class="control-group">
                            <label for="rampSlider">Ramp Period: <span id="rampValue">10s</span></label>
                            <div class="slider-container">
                                <input type="range" id="rampSlider" min="5" max="20" value="10">
                                <span class="info-icon" data-tooltip-id="tooltip-ramp">?</span>
                            </div>
                            <div class="tooltip" id="tooltip-ramp">How quickly the sound fades in to the target volume when activated.</div>
                        </div>
                        <div class="control-group">
                            <label for="oscillationSlider">Oscillation Period: <span id="oscillationValue">9s</span></label>
                            <div class="slider-container">
                                <input type="range" id="oscillationSlider" min="2" max="20" value="9">
                                <span class="info-icon" data-tooltip-id="tooltip-period">?</span>
                            </div>
                            <div class="tooltip" id="tooltip-period">The time it takes for the volume to complete one full wave (up and down) around the target volume.</div>
                        </div>
                        <div class="control-group">
                            <label for="oscillationDepthSlider">Oscillation Depth: <span id="oscillationDepthValue">50%</span></label>
                            <div class="slider-container">
                                <input type="range" id="oscillationDepthSlider" min="0" max="100" value="50">
                                <span class="info-icon" data-tooltip-id="tooltip-depth">?</span>
                            </div>
                            <div class="tooltip" id="tooltip-depth">How much the volume varies during oscillation. 0% is no oscillation, 100% will cause the volume to swing between silent and double the target.</div>
                        </div>
                    </div>
                </details>
            </div>
        </div>
    </div>
    <div id="screensaver">
        <div>
            <p id="screensaverText">Monitoring</p>
            <button id="returnButton">Return to Controls</button>
        </div>
    </div>
    
    <script>
        // --- SECTION 1: DOM ELEMENT REFERENCES ---
        const startButton = document.getElementById('startButton');
        const triggerSlider = document.getElementById('triggerSlider');
        const volumeSlider = document.getElementById('volumeSlider');
        const sensitivitySlider = document.getElementById('sensitivitySlider');
        const durationSlider = document.getElementById('durationSlider');
        const rampSlider = document.getElementById('rampSlider');
        const oscillationSlider = document.getElementById('oscillationSlider');
        const oscillationDepthSlider = document.getElementById('oscillationDepthSlider');
        const screensaverToggle = document.getElementById('screensaverToggle');
        const triggerValueSpan = document.getElementById('triggerValue');
        const volumeValueSpan = document.getElementById('volumeValue');
        const sensitivityValueSpan = document.getElementById('sensitivityValue');
        const durationValueSpan = document.getElementById('durationValue');
        const rampValueSpan = document.getElementById('rampValue');
        const oscillationValueSpan = document.getElementById('oscillationValue');
        const oscillationDepthValueSpan = document.getElementById('oscillationDepthValue');
        const triggerLine = document.getElementById('triggerLine');
        const soundLevelValue = document.getElementById('soundLevelValue');
        const activationStatus = document.getElementById('activationStatus');
        const screensaver = document.getElementById('screensaver');
        const returnButton = document.getElementById('returnButton');

        // --- SECTION 2: CONFIGURATION & STATE VARIABLES ---
        let disturbanceTriggerLevel = 50;
        let sensitivityThreshold = 60; // Initial value before slider is moved
        let targetVolume = 0.5;
        let decayDuration = 30;
        let rampPeriod = 10;
        let oscillationPeriod = 9;
        let oscillationDepth = 0.5;
        let isMonitoring = false;
        let screensaverEnabled = true;
        let animationFrameId = null;
        let breachRecords = [];
        let allTimeouts = [];
        let decayEndTime = null;
        let inactivityTimer = null;
        let isMicActive = false;
        
        // --- SECTION 3: AUDIO API & STATE VARIABLES ---
        let audioContext;
        let streamSource;
        let mediaStreamSource;
        let analyser;
        let dataArray;
        let whiteNoiseNode = null;
        let lfoNode = null;
        let lfoGain = null;
        let masterGainNode = null;
        let audioState = 'idle';

        // --- SECTION 4: EVENT LISTENERS ---
        startButton.addEventListener('click', () => {
            resetInactivityTimer();
            if (!isMicActive) {
                initializeMicrophone();
            } else if (isMonitoring) {
                stopPlaybackAndMonitoring();
            } else {
                startPlaybackAndMonitoring();
            }
        });

        returnButton.addEventListener('click', resetInactivityTimer);
        screensaverToggle.addEventListener('change', (e) => {
            screensaverEnabled = e.target.checked;
            resetInactivityTimer();
        });

        document.querySelectorAll('.info-icon').forEach(icon => {
            const tooltipId = icon.getAttribute('data-tooltip-id');
            const tooltip = document.getElementById(tooltipId);
            
            icon.addEventListener('click', (e) => {
                e.stopPropagation();
                const isVisible = tooltip.classList.contains('show');
                document.querySelectorAll('.tooltip.show').forEach(t => t.classList.remove('show'));
                if (!isVisible) {
                    tooltip.classList.add('show');
                }
            });
        });
        document.addEventListener('click', () => {
            document.querySelectorAll('.tooltip.show').forEach(t => t.classList.remove('show'));
        });


        [triggerSlider, volumeSlider, sensitivitySlider, durationSlider, rampSlider, oscillationSlider, oscillationDepthSlider].forEach(slider => {
            slider.addEventListener('input', resetInactivityTimer);
        });

        triggerSlider.addEventListener('input', (e) => {
            disturbanceTriggerLevel = parseInt(e.target.value);
            triggerValueSpan.textContent = disturbanceTriggerLevel;
            triggerLine.style.bottom = `${disturbanceTriggerLevel}%`;
        });

        volumeSlider.addEventListener('input', (e) => {
            const newVolume = parseInt(e.target.value);
            targetVolume = newVolume / 100;
            volumeValueSpan.textContent = `${newVolume}%`;
            if (masterGainNode && audioContext) {
                masterGainNode.gain.setTargetAtTime(targetVolume, audioContext.currentTime, 0.1);
            }
            if (lfoGain && audioContext) {
                lfoGain.gain.setTargetAtTime(targetVolume * oscillationDepth, audioContext.currentTime, 0.5);
            }
        });

        sensitivitySlider.addEventListener('input', (e) => {
            const sliderValue = parseInt(e.target.value); // 1-100
            // Map slider 1-100 to a threshold of 60-40. Higher slider value = lower threshold (more sensitive).
            sensitivityThreshold = 60 - ((sliderValue - 1) * (20 / 99));
            sensitivityValueSpan.textContent = sliderValue;
        });
        
        durationSlider.addEventListener('input', (e) => {
            const sliderValue = parseInt(e.target.value);
            const minSec = 5; const maxSec = 1800;
            const minLog = Math.log(minSec); const maxLog = Math.log(maxSec);
            const scale = (maxLog - minLog) / 99;
            decayDuration = Math.exp(minLog + scale * (sliderValue - 1));
            durationValueSpan.textContent = decayDuration < 60 ? `${Math.round(decayDuration)}s` : `${Math.round(decayDuration / 60)}m`;
        });
        
        rampSlider.addEventListener('input', (e) => {
            rampPeriod = parseInt(e.target.value);
            rampValueSpan.textContent = `${rampPeriod}s`;
        });

        oscillationSlider.addEventListener('input', (e) => {
            oscillationPeriod = parseInt(e.target.value);
            oscillationValueSpan.textContent = `${oscillationPeriod}s`;
            if (lfoNode) {
                lfoNode.frequency.setTargetAtTime(1 / oscillationPeriod, audioContext.currentTime, 0.1);
            }
        });

        oscillationDepthSlider.addEventListener('input', (e) => {
            const depthPercentage = parseInt(e.target.value);
            oscillationDepth = depthPercentage / 100;
            oscillationDepthValueSpan.textContent = `${depthPercentage}%`;
            if(lfoGain) {
                lfoGain.gain.setTargetAtTime(targetVolume * oscillationDepth, audioContext.currentTime, 0.5);
            }
        });


        // --- SECTION 5: CORE LOGIC ---
        async function initializeMicrophone() {
             try {
                audioContext = new AudioContext();
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { 
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }, 
                    video: false 
                });
                streamSource = stream;
                
                mediaStreamSource = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                mediaStreamSource.connect(analyser);
                dataArray = new Uint8Array(analyser.frequencyBinCount);

                isMicActive = true;
                mainLoop(); // Start continuous analysis
                startPlaybackAndMonitoring();

            } catch (err) {
                console.error('Error:', err);
                startButton.textContent = "Mic Error - Refresh";
            }
        }
        
        function startPlaybackAndMonitoring() {
            isMonitoring = true;
            startButton.textContent = 'Stop Monitoring';
            startButton.style.backgroundColor = '#C62828';
            triggerLine.style.backgroundColor = '#C62828';
            resetInactivityTimer();
        }

        function stopPlaybackAndMonitoring() {
            isMonitoring = false;
            cleanupAudioNodes();
            if (inactivityTimer) {
                clearTimeout(inactivityTimer);
                inactivityTimer = null;
            }
            hideScreensaver();
            
            breachRecords = [];
            decayEndTime = null;
            startButton.textContent = `Start Monitoring`;
            startButton.style.backgroundColor = '#00796B';
            triggerLine.style.backgroundColor = '#00796B';
        }

        function mainLoop() {
            if (!isMicActive) return;

            analyser.getByteFrequencyData(dataArray);
            
            const scaledVolume = calculateLogVolume(dataArray);
            soundLevelValue.textContent = scaledVolume;
            
            const disturbanceLevel = calculateDisturbanceLevel(scaledVolume);
            document.getElementById('soundBar').style.height = `${disturbanceLevel}%`;
            
            if (isMonitoring) {
                 if (disturbanceLevel > disturbanceTriggerLevel) {
                    triggerSoundPlayback();
                }
            }

            if (audioState === 'decaying' && decayEndTime) {
                const remaining = Math.max(0, (decayEndTime - Date.now()) / 1000);
                const displayTime = Math.round(remaining / 5) * 5;
                activationStatus.textContent = `Time Remaining: ${displayTime}s`;
            } else if (audioState !== 'idle' && audioState !== 'decaying') {
                activationStatus.textContent = 'Activated';
            } else {
                activationStatus.textContent = '-';
            }

            animationFrameId = requestAnimationFrame(mainLoop);
        }

        // --- SECTION 6: SMOOTH AUDIO ENGINE ---
        function triggerSoundPlayback() {
            const now = audioContext.currentTime;
            
            if (audioState === 'idle') {
                audioState = 'rampingUp';
                createAudioNodes();
                masterGainNode.gain.setValueAtTime(0.0001, now);
                masterGainNode.gain.linearRampToValueAtTime(targetVolume, now + rampPeriod);
                
                scheduleTimeout(() => {
                    if (audioState === 'rampingUp') {
                        audioState = 'holdingAfterRampUp';
                        scheduleTimeout(() => {
                            if (audioState === 'holdingAfterRampUp') {
                                startDecay();
                            }
                        }, 1000);
                    }
                }, rampPeriod * 1000);
            }
            else if (audioState === 'decaying') {
                audioState = 'holdingAfterInterrupt';
                clearAllTimeouts();

                masterGainNode.gain.cancelScheduledValues(now);
                if (lfoGain.numberOfOutputs > 0) { try { lfoGain.disconnect(masterGainNode.gain); } catch(e) {} }
                masterGainNode.gain.setValueAtTime(masterGainNode.gain.value, now);

                scheduleTimeout(() => {
                    if (audioState === 'holdingAfterInterrupt') {
                        audioState = 'rampingUp';
                        const rampUpStartTime = audioContext.currentTime;
                        masterGainNode.gain.linearRampToValueAtTime(targetVolume, rampUpStartTime + rampPeriod);
                        
                        scheduleTimeout(() => {
                            if (audioState === 'rampingUp') {
                                audioState = 'holdingAfterRampUp';
                                scheduleTimeout(() => {
                                    if (audioState === 'holdingAfterRampUp') {
                                        startDecay();
                                    }
                                }, 1000);
                            }
                        }, rampPeriod * 1000);
                    }
                }, 1000);
            }
        }
        
        function startDecay() {
            audioState = 'decaying';
            decayEndTime = Date.now() + decayDuration * 1000;
            const now = audioContext.currentTime;

            masterGainNode.gain.setValueAtTime(targetVolume, now);
            masterGainNode.gain.linearRampToValueAtTime(0.0001, now + decayDuration);

            lfoGain.connect(masterGainNode.gain);
            lfoGain.gain.linearRampToValueAtTime(0, now + decayDuration);
            
            scheduleTimeout(cleanupAudioNodes, (decayDuration + 1) * 1000);
        }

        function createAudioNodes() {
            masterGainNode = audioContext.createGain();
            masterGainNode.connect(audioContext.destination);

            const bufferSize = 2 * audioContext.sampleRate;
            const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
            const output = noiseBuffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) { output[i] = Math.random() * 2 - 1; }
            whiteNoiseNode = audioContext.createBufferSource();
            whiteNoiseNode.buffer = noiseBuffer;
            whiteNoiseNode.loop = true;
            whiteNoiseNode.connect(masterGainNode);

            lfoNode = audioContext.createOscillator();
            lfoNode.type = 'sine';
            lfoNode.frequency.setValueAtTime(1 / oscillationPeriod, audioContext.currentTime);
            lfoGain = audioContext.createGain();
            lfoGain.gain.setValueAtTime(targetVolume * oscillationDepth, audioContext.currentTime);
            lfoNode.connect(lfoGain);

            whiteNoiseNode.start(audioContext.currentTime);
            lfoNode.start(audioContext.currentTime);
        }

        function cleanupAudioNodes() {
            clearAllTimeouts(); 
            decayEndTime = null;
            if (whiteNoiseNode) { try { whiteNoiseNode.stop(0); whiteNoiseNode.disconnect(); } catch (e) {} }
            if (lfoNode) { try { lfoNode.stop(0); lfoNode.disconnect(); } catch (e) {} }
            if (lfoGain) { try { lfoGain.disconnect(); } catch (e) {} }
            if (masterGainNode) { try { masterGainNode.disconnect(); } catch (e) {} }
            whiteNoiseNode = lfoNode = lfoGain = masterGainNode = null;
            audioState = 'idle';
        }
        
        // --- SECTION 7: HELPER & INACTIVITY FUNCTIONS ---
        function resetInactivityTimer() {
            if (inactivityTimer) clearTimeout(inactivityTimer);
            hideScreensaver();
            if (screensaverEnabled && isMonitoring) {
                inactivityTimer = setTimeout(showScreensaver, 10000);
            }
        }

        function showScreensaver() {
            screensaver.style.display = 'flex';
            setTimeout(() => screensaver.style.opacity = '1', 10);
        }

        function hideScreensaver() {
            screensaver.style.opacity = '0';
            setTimeout(() => screensaver.style.display = 'none', 500);
        }

        function scheduleTimeout(callback, delay) {
            const id = setTimeout(callback, delay);
            allTimeouts.push(id);
            return id;
        }

        function clearAllTimeouts() {
            allTimeouts.forEach(clearTimeout);
            allTimeouts = [];
        }

        function calculateLogVolume(dataArray) {
            let sum = 0;
            for (const amplitude of dataArray) { sum += amplitude * amplitude; }
            const rawVolume = Math.sqrt(sum / dataArray.length);
            return Math.min(100, Math.round(25 * Math.log(rawVolume + 1)));
        }

        function calculateDisturbanceLevel(currentVolume) {
            if (currentVolume > sensitivityThreshold) {
                breachRecords.push({ timestamp: Date.now(), magnitude: currentVolume - sensitivityThreshold });
            }

            const now = Date.now();
            const tenSecondsAgo = now - 10000;
            breachRecords = breachRecords.filter(record => record.timestamp > tenSecondsAgo);
            if (breachRecords.length === 0) { return 0; }
            let totalScore = 0;
            for (const record of breachRecords) {
                const recencyWeight = (record.timestamp - tenSecondsAgo) / 10000;
                totalScore += record.magnitude * recencyWeight;
            }
            const scoreAsPercentage = Math.min(1.0, totalScore / 5000);
            const curvedScore = Math.pow(scoreAsPercentage, 2.0);
            return Math.round(curvedScore * 100);
        }
    </script>
</body>
</html>


