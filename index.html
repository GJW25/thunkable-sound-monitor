<!DOCTYPE html>
<html>
<head>
    <title>Audio Processor</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #212121;
            color: #e0e0e0; 
            text-align: center; 
            touch-action: none;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            margin: 0;
        }
        #shushMessage {
            display: none; 
            font-size: 3em; 
            font-weight: bold;
            color: #C62828;
            margin-top: 10px;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        #mainContainer { display: flex; flex-direction: column; align-items: center; }
        #mainContent { display: none; width: 100%; }
        #startButton {
            padding: 15px 30px;
            font-size: 1.2em;
            cursor: pointer;
            border-radius: 8px;
            border: none;
            background-color: #00796B;
            color: white;
            margin-bottom: 20px;
        }
        #visualizerContainer {
            width: 80px;
            height: 150px; /* Reduced height for more space */
            background-color: #333;
            border: 2px solid #555;
            border-radius: 8px;
            margin: 10px auto;
            position: relative;
            overflow: hidden;
        }
        #soundBar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0%;
            background: linear-gradient(to top, #4A90E2, #F5A623);
            transition: height 0.1s linear;
        }
        #triggerLine {
            position: absolute;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: #BDBDBD;
            bottom: 50%;
            transition: bottom 0.2s ease;
        }
        /* New slider controls styling */
        .controls { margin-top: 15px; width: 90%; max-width: 300px; }
        .control-group { margin-bottom: 10px; text-align: left; }
        .control-group label { display: block; margin-bottom: 5px; font-size: 0.9em; }
        .control-group input[type="range"] { width: 100%; }
    </style>
</head>
<body>
    <div id="mainContainer">
        <button id="startButton">Start Monitoring (v1.8)</button>
        <div id="mainContent">
            <div id="visualizerContainer">
                <div id="soundBar"></div>
                <div id="triggerLine"></div>
            </div>
            <div class="controls">
                <div class="control-group">
                    <label for="triggerSlider">Trigger Level: <span id="triggerValue">50</span></label>
                    <input type="range" id="triggerSlider" min="10" max="100" value="50">
                </div>
                <div class="control-group">
                    <label for="volumeSlider">Max Noise Volume: <span id="volumeValue">50</span>%</label>
                    <input type="range" id="volumeSlider" min="0" max="100" value="50">
                </div>
                <div class="control-group">
                    <label for="sensitivitySlider">Disturbance Sensitivity: <span id="sensitivityValue">50</span></label>
                    <input type="range" id="sensitivitySlider" min="1" max="100" value="50">
                </div>
            </div>
            <div id="shushMessage">Shusssshhhhh</div>
        </div>
    </div>
    
    <script>
        // --- DOM ELEMENTS ---
        const startButton = document.getElementById('startButton');
        const mainContent = document.getElementById('mainContent');
        const triggerSlider = document.getElementById('triggerSlider');
        const volumeSlider = document.getElementById('volumeSlider');
        const sensitivitySlider = document.getElementById('sensitivitySlider');
        const triggerValueSpan = document.getElementById('triggerValue');
        const volumeValueSpan = document.getElementById('volumeValue');
        const sensitivityValueSpan = document.getElementById('sensitivityValue');

        // --- CONFIGURATION & STATE VARIABLES ---
        let volumeThreshold = 50;
        let maxNoiseVolume = 0.5; // 0.0 to 1.0
        let disturbanceSensitivity = 5000; // Mapped from slider
        let isMonitoring = false;
        let animationFrameId = null;

        let breachRecords = [];
        let disturbanceHistory = [];
        let isShushing = false;
        
        // --- AUDIO VARIABLES ---
        let audioContext;
        let streamSource;
        let whiteNoiseNode = null;
        let lfoNode = null;
        let masterGainNode = null;

        // --- EVENT LISTENERS ---
        startButton.addEventListener('click', () => {
            if (isMonitoring) {
                stopMonitoring();
            } else {
                startMonitoring();
            }
        });

        triggerSlider.addEventListener('input', (e) => {
            volumeThreshold = parseInt(e.target.value);
            triggerValueSpan.textContent = volumeThreshold;
        });

        volumeSlider.addEventListener('input', (e) => {
            maxNoiseVolume = parseInt(e.target.value) / 100;
            volumeValueSpan.textContent = `${e.target.value}%`;
        });

        sensitivitySlider.addEventListener('input', (e) => {
            // Map slider (1-100) to a score (10000-1000). Lower score = more sensitive.
            disturbanceSensitivity = 10100 - (parseInt(e.target.value) * 100);
            sensitivityValueSpan.textContent = e.target.value;
        });

        // --- CORE LOGIC ---
        async function startMonitoring() {
            if (isMonitoring) return;
            isMonitoring = true;
            mainContent.style.display = 'block';
            startButton.textContent = 'Stop Monitoring';
            startButton.style.backgroundColor = '#C62828'; // Change to red

            try {
                audioContext = new AudioContext();
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                streamSource = stream;
                
                const mediaStreamSource = audioContext.createMediaStreamSource(stream);
                const analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                mediaStreamSource.connect(analyser);
                const dataArray = new Uint8Array(analyser.frequencyBinCount);

                function mainLoop() {
                    analyser.getByteFrequencyData(dataArray);
                    
                    let sum = 0;
                    for (const amplitude of dataArray) { sum += amplitude * amplitude; }
                    const rawVolume = Math.sqrt(sum / dataArray.length);
                    const scaledVolume = Math.min(100, Math.round(18 * Math.log(rawVolume + 1)));
                    
                    if (scaledVolume > volumeThreshold) {
                        breachRecords.push({ timestamp: Date.now(), magnitude: scaledVolume - volumeThreshold });
                    }

                    const disturbanceLevel = calculateDisturbanceLevel();
                    const now = Date.now();
                    disturbanceHistory.push({ timestamp: now, level: disturbanceLevel });
                    disturbanceHistory = disturbanceHistory.filter(record => record.timestamp > now - 3000); // 3-second average
                    
                    document.getElementById('soundBar').style.height = `${disturbanceLevel}%`;

                    if (disturbanceLevel > 50) {
                        manageWhiteNoise();
                    }

                    if (disturbanceLevel > 50 && !isShushing) {
                        isShushing = true; 
                        document.getElementById('shushMessage').style.display = 'block';
                        setTimeout(() => {
                            document.getElementById('shushMessage').style.display = 'none';
                            isShushing = false;
                        }, 10000);
                    }
                    
                    animationFrameId = requestAnimationFrame(mainLoop);
                }
                mainLoop();
            
            } catch (err) {
                console.error('Error:', err);
                stopMonitoring(); // Reset on error
            }
        }

        function stopMonitoring() {
            if (!isMonitoring) return;

            cancelAnimationFrame(animationFrameId);
            stopWhiteNoise();
            
            if (streamSource) {
                streamSource.getTracks().forEach(track => track.stop());
            }
            if (audioContext && audioContext.state !== 'closed') {
                audioContext.close();
            }

            // Reset state
            isMonitoring = false;
            breachRecords = [];
            disturbanceHistory = [];
            animationFrameId = null;
            streamSource = null;
            mainContent.style.display = 'none';
            startButton.textContent = 'Start Monitoring (v1.8)';
            startButton.style.backgroundColor = '#00796B'; // Back to green
        }

        function manageWhiteNoise() {
            const avgDisturbance = calculateAverageDisturbance();
            const clampedAvg = Math.max(50, avgDisturbance);
            // Peak volume is now scaled by the volume slider
            const peakVolume = (((clampedAvg - 50) / 50) * 0.4 + 0.1) * maxNoiseVolume;

            if (!whiteNoiseNode) {
                masterGainNode = audioContext.createGain();
                masterGainNode.connect(audioContext.destination);

                const bufferSize = 2 * audioContext.sampleRate;
                const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
                const output = noiseBuffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) { output[i] = Math.random() * 2 - 1; }
                whiteNoiseNode = audioContext.createBufferSource();
                whiteNoiseNode.buffer = noiseBuffer;
                whiteNoiseNode.loop = true;
                whiteNoiseNode.connect(masterGainNode);

                lfoNode = audioContext.createOscillator();
                lfoNode.type = 'sine';
                lfoNode.frequency.setValueAtTime(0.2, audioContext.currentTime);
                const lfoGain = audioContext.createGain();
                lfoGain.gain.setValueAtTime(0.04 * maxNoiseVolume, audioContext.currentTime);
                lfoNode.connect(lfoGain);
                lfoGain.connect(masterGainNode.gain);

                const now = audioContext.currentTime;
                masterGainNode.gain.setValueAtTime(0.0001, now);
                masterGainNode.gain.setTargetAtTime(peakVolume, now, 4.0); // Slower ramp-up (4.0)

                whiteNoiseNode.start(now);
                lfoNode.start(now);
                setTimeout(stopWhiteNoise, 30000);
            } else {
                masterGainNode.gain.setTargetAtTime(peakVolume, audioContext.currentTime, 1.5);
            }
        }

        function stopWhiteNoise() {
            if (!masterGainNode) return;
            const now = audioContext.currentTime;
            masterGainNode.gain.setTargetAtTime(0.0001, now, 1.5);
            const stopTime = now + 5;
            if (whiteNoiseNode) whiteNoiseNode.stop(stopTime);
            if (lfoNode) lfoNode.stop(stopTime);
            whiteNoiseNode = null;
            lfoNode = null;
            masterGainNode = null;
        }

        function calculateAverageDisturbance() {
            if (disturbanceHistory.length === 0) return 0;
            const sum = disturbanceHistory.reduce((acc, record) => acc + record.level, 0);
            return sum / disturbanceHistory.length;
        }

        function calculateDisturbanceLevel() {
            const now = Date.now();
            const tenSecondsAgo = now - 10000;
            breachRecords = breachRecords.filter(record => record.timestamp > tenSecondsAgo);
            if (breachRecords.length === 0) { return 0; }
            let totalScore = 0;
            for (const record of breachRecords) {
                const recencyWeight = (record.timestamp - tenSecondsAgo) / 10000;
                totalScore += record.magnitude * recencyWeight;
            }
            // Use the dynamic sensitivity value here
            const scoreAsPercentage = Math.min(1.0, totalScore / disturbanceSensitivity);
            const curvedScore = Math.pow(scoreAsPercentage, 2.0);
            return Math.round(curvedScore * 100);
        }
    </script>
</body>
</html>



